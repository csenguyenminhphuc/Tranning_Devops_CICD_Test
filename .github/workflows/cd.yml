name: CD - Deploy via Cloudflare Tunnel

on:
  workflow_run:
    workflows: ["CI - Test & Build"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Install Cloudflared
      run: |
        # Download and install cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        cloudflared --version
    
    - name: Setup SSH Key
      env:
        TUNNEL_SERVICE_TOKEN_ID: ${{ secrets.TUNNEL_SERVICE_TOKEN_ID }}
        TUNNEL_SERVICE_TOKEN_SECRET: ${{ secrets.TUNNEL_SERVICE_TOKEN_SECRET }}
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519

        # Configure SSH to use cloudflared for proxy with service token authentication
        cat > ~/.ssh/config << EOF
        Host ${{ secrets.VPS_HOST }}
          ProxyCommand cloudflared access ssh --hostname %h --id ${TUNNEL_SERVICE_TOKEN_ID} --secret ${TUNNEL_SERVICE_TOKEN_SECRET}
          User ${{ secrets.VPS_USER }}
          IdentityFile ~/.ssh/id_ed25519
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        chmod 600 ~/.ssh/config
    
    - name: Deploy to Server via Cloudflare Tunnel
      env:
        TUNNEL_SERVICE_TOKEN_ID: ${{ secrets.TUNNEL_SERVICE_TOKEN_ID }}
        TUNNEL_SERVICE_TOKEN_SECRET: ${{ secrets.TUNNEL_SERVICE_TOKEN_SECRET }}
      run: |
        ssh ${{ secrets.VPS_HOST }} << 'ENDSSH'
          set -e
          echo "ðŸ“‚ Navigating to project directory..."
          cd /opt/myapp || { mkdir -p /opt/myapp && cd /opt/myapp; }
          
          echo "ðŸ“¥ Pulling latest code..."
          if [ -d .git ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            git clone https://github.com/${{ github.repository }} .
          fi
          
          echo "ðŸ”§ Creating environment file..."
          cat > .env << 'EOF'
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
        EOF
          
          echo "ðŸš€ Deploying with Docker Compose..."
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          
          echo "â³ Waiting for containers to start..."
          sleep 20
          
          echo "ðŸ¥ Health check..."
          if docker compose ps | grep -E "Up|running"; then
            echo "âœ… Deploy successful!"
            docker compose ps
          else
            echo "âŒ Deploy failed!"
            docker compose logs --tail=50
            exit 1
          fi
          
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f
        ENDSSH
