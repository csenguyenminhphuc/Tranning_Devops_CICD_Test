name: CD - Deploy via Cloudflare Tunnel

on:
  workflow_run:
    workflows: ["CI - Test & Build"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Install Cloudflared
      run: |
        # Download and install cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        cloudflared --version
    
    - name: Setup SSH Key and Cloudflare Access Token
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519

        # Pre-authenticate with Cloudflare Access using service token
        echo "ðŸ” Authenticating with Cloudflare Access..."
        cloudflared access login ${{ secrets.VPS_HOST }} || true
        
        # Configure SSH to use cloudflared proxy (without auth flags since we pre-authenticated)
        cat > ~/.ssh/config << 'EOF'
        Host ${{ secrets.VPS_HOST }}
          ProxyCommand cloudflared access ssh --hostname %h
          User ${{ secrets.VPS_USER }}
          IdentityFile ~/.ssh/id_ed25519
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
        EOF
        chmod 600 ~/.ssh/config
        echo "ðŸ” SSH Config created:"
        cat ~/.ssh/config
    
    - name: Deploy to Server via Cloudflare Tunnel
      run: |
        # Deploy
        ssh ${{ secrets.VPS_HOST }} << 'ENDSSH'
          set -e
          echo "ðŸ“‚ Setting up project directory..."
          
          # Navigate to home directory
          cd "$HOME"
          
          # Create myapp directory if it doesn't exist
          mkdir -p myapp
          cd myapp
          
          # Define repo directory name (extracted from repository)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          echo "ðŸ“¥ Pulling latest code..."
          if [ -d "$REPO_NAME" ]; then
            echo "Repository directory exists, updating..."
            cd "$REPO_NAME"
            git fetch origin main
            git reset --hard origin/main
          else
            echo "Cloning repository..."
            git clone https://github.com/${{ github.repository }}
            cd "$REPO_NAME"
          fi
          
          echo "ðŸ“ Current directory: $(pwd)"
          
          echo "ðŸ”§ Creating environment file..."
          cat > .env << 'EOF'
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=db
          DB_PORT=5432
        EOF
          
          echo "ðŸš€ Deploying with Docker Compose..."
          docker compose down
          docker compose build --no-cache
          docker compose up -d
          
          echo "â³ Waiting for containers to start..."
          sleep 20
          
          echo "ðŸ¥ Health check..."
          if docker compose ps | grep -E "Up|running"; then
            echo "âœ… Deploy successful!"
            docker compose ps
          else
            echo "âŒ Deploy failed!"
            docker compose logs --tail=50
            exit 1
          fi
          
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f
        ENDSSH
